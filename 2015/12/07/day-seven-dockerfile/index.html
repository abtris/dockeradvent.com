<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Day Seven - Dockerfile &middot; Docker Advent
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Docker Advent
        </a>
      </h1>
      <p class="lead">Made by <a href="https://twitter.com/abtris" target="_blank">@abtris</a>.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/abtris/dockeradvent.com">GitHub project</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Day Seven - Dockerfile</h1>
  <span class="post-date">07 Dec 2015</span>
  <p>Hi everyone,<br>
if you can start making own images you need <code>Dockerfile</code>. This file describe how is image created. Every command is cachable in separate layer and this is helpful if adding new commands, rebuild is more faster than you use tools as Puppet, Chef or Ansible.</p>

<p><a href="http://docs.docker.com/engine/reference/builder/">Dockerfile</a> can contains many commands.</p>

<h2>Structure</h2>

<p>Minimum file is for example used in Heroku:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">from</span> heroku/nodejs
</code></pre></div>
<p>and this is only one line! This image has parent image with <code>Dockerfile</code> contains:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="c"># Inherit from Heroku&#39;s stack</span>
<span class="k">FROM</span> heroku/cedar:14

<span class="c"># Internally, we arbitrarily use port 3000</span>
<span class="k">ENV</span> PORT <span class="m">3000</span>
<span class="c"># Which version of node?</span>
<span class="k">ENV</span> NODE_ENGINE 0.12.2
<span class="c"># Locate our binaries</span>
<span class="k">ENV</span> PATH /app/heroku/node/bin/:/app/user/node_modules/.bin:<span class="nv">$PATH</span>

<span class="c"># Create some needed directories</span>
<span class="k">RUN</span> mkdir -p /app/heroku/node /app/.profile.d
<span class="k">WORKDIR</span> /app/user

<span class="c"># Install node</span>
<span class="k">RUN</span> curl -s https://s3pository.heroku.com/node/v<span class="nv">$NODE_ENGINE</span>/node-v<span class="nv">$NODE_ENGINE</span>-linux-x64.tar.gz <span class="p">|</span> tar --strip-components<span class="o">=</span><span class="m">1</span> -xz -C /app/heroku/node

<span class="c"># Export the node path in .profile.d</span>
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&quot;export PATH=\&quot;/app/heroku/node/bin:/app/user/node_modules/.bin:\$PATH\&quot;&quot;</span> &gt; /app/.profile.d/nodejs.sh

<span class="n-Keyword">ONBUILD</span><span class="w"> </span><span class="k">ADD</span> package.json /app/user/
<span class="n-Keyword">ONBUILD</span><span class="w"> </span><span class="k">RUN</span> /app/heroku/node/bin/npm install
<span class="n-Keyword">ONBUILD</span><span class="w"> </span><span class="k">ADD</span> . /app/user/
</code></pre></div>
<p>This parent is <code>heroku/cedar:14</code> and his <code>Dockerfile</code>:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span> ubuntu-debootstrap:14.04
COPY ./cedar-14.sh /tmp/build.sh
<span class="k">RUN</span> <span class="nv">LC_ALL</span><span class="o">=</span>C <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive /tmp/build.sh
</code></pre></div>
<p>and this parent <code>ubuntu-debootstrap:14.04</code> is:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span> scratch
<span class="k">ADD</span> rootfs.tar.xz /
<span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;/bin/bash&quot;</span><span class="o">]</span>
</code></pre></div>
<p>and <code>scratch</code> is <a href="https://hub.docker.com/r/library/scratch/">empty image</a> that is used explicitly to build new images.</p>

<h2>Commands</h2>

<p>You start with <code>FROM</code>. Usually use smallest possible image or image used in your servers.</p>

<p>For adding files into image use <code>ADD</code> or <code>COPY</code>.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">If you&#39;re not interested in the nuances of ADD and COPY and just want an answer to &quot;which one should I use?&quot;, all you need to know is: use COPY. - [Brian DeHamer](https://labs.ctl.io/dockerfile-add-vs-copy/)
</code></pre></div>
<p>In simple way <code>ADD</code> use only for URL address or archives.</p>

<p>Next is <code>RUN</code> command, you can run any OS command. Every <code>RUN</code> is in separate layer and it&#39;s useful if you group commands.</p>

<p>Instead using:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">RUN</span> apt-get update
<span class="k">RUN</span> apt-get install -y package-bar
<span class="k">RUN</span> apt-get install -y package-baz
<span class="k">RUN</span> apt-get install -y package-foo
</code></pre></div>
<p>use this:</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y <span class="err">\</span>
        package-bar <span class="err">\</span>
        package-baz <span class="err">\</span>
        package-foo <span class="err">\</span>
    <span class="o">&amp;&amp;</span> apt-get clean <span class="err">\</span>
    <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
</code></pre></div>
<p>First example create 4 images for every layer. Second create only one and clean after install. This helps with image size.</p>

<p>If you need ports use <code>EXPOSE</code>, for environment properties <code>ENV</code></p>

<p><code>ENTRYPOINT</code> is main image command and <code>CMD</code> is for default flags.</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">ENTRYPOINT</span> <span class="o">[</span><span class="s2">&quot;node&quot;</span><span class="o">]</span>
<span class="k">CMD</span> <span class="o">[</span><span class="s2">&quot;--version&quot;</span><span class="o">]</span>
</code></pre></div>
<p>Now the image can be run like this to show the commandâ€™s help:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker run node
</code></pre></div>
<p>Or using the right parameters to execute a command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker run node install aws-sdk
</code></pre></div>
<p>You can define <code>VOLUME</code>, <code>USER</code>, <code>WORKDIR</code> if you need it.</p>

<p>Last interesting command is <code>ONBUILD</code>. I like this, you can defined some parts in parent image. This commands will be executed in building only for child image. Example we have in our image where is <code>FROM heroku/nodejs</code> image. This image in build execute sequence defined in <code>heroku\nodejs</code> image.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ONBUILD ADD package.json /app/user/
ONBUILD RUN /app/heroku/node/bin/npm install
ONBUILD ADD . /app/user/
</code></pre></div>
<p>in our image is added <code>package.json</code> and install all dependencies. After that add your source code.</p>

<p>This is very good example how use <code>ONBUILD</code> as template for your apps. Another examples are many images for <a href="https://hub.docker.com/_/golang/">golang</a>, <a href="https://hub.docker.com/_/perl/">perl</a>, <a href="https://hub.docker.com/_/rails/">rails</a>, <a href="https://hub.docker.com/_/node/">nodejs</a>, <a href="https://hub.docker.com/_/php/">php</a>, <a href="https://hub.docker.com/_/wordpress/">wordpress</a>, <a href="https://hub.docker.com/_/java/">java</a> as based images.</p>

<p>See you tomorrow,<br>
Ladislav</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/12/24/day-twenty-four-docker-advent-summary/">
            Day Twenty Four - Docker Advent Summary 2015
            <small>24 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/23/day-twenty-three-docker-tips-and-tricks/">
            Day Twenty Three - Docker tips and tricks
            <small>23 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/22/day-twenty-two-docker-and-monitoring/">
            Day Twenty Two - Docker and monitoring
            <small>22 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693925-3', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
