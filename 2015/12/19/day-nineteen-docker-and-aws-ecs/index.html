<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Day Nineteen - Docker and AWS ECS &middot; Docker Advent
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Docker Advent
        </a>
      </h1>
      <p class="lead">Made by <a href="https://twitter.com/abtris" target="_blank">@abtris</a>.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/abtris/dockeradvent.com">GitHub project</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Day Nineteen - Docker and AWS ECS</h1>
  <span class="post-date">19 Dec 2015</span>
  <p>Hi everyone,<br>
Amazon Web Services (AWS) is biggest cloud provider and you can use docker with Elastic Compute Cloud (EC2), use Amazon EC2 Container Service (ECS) or AWS Elastic Beanstalk. <a href="https://aws.amazon.com/elasticbeanstalk/">AWS Elastic Beanstalk</a> is very similar to Heroku. It&#39;s Platform as a Service (PaaS).</p>

<p>I write post about ECS. ECS is new service exists two years. You have to use your EC2 instances to provide cluster. No price for service itself only for resources (EC2, ELB, EBS).</p>

<p>This year <a href="https://github.com/aws/amazon-ecs-cli">Amazon ECS CLI</a> introduce support for <code>docker-compose.yml</code>.</p>

<p>I use this command to create task definition for ECS using this command:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">AWS_REGION=us-east-1 ecs-cli compose create
</code></pre></div>
<p>this is example <code>docker-compose.yml</code> for docker registry:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">backend:
  image: registry
  cpu_shares: 400
  mem_limit: 314572800
  ports:
    - 5000:5000
  environment:
    AWS_BUCKET: &lt;DOCKER-REGISTRY-BUCKET&gt;
    AWS_ENCRYPT: &#39;False&#39;
    AWS_KEY: &lt;AWS-KEY&gt;
    AWS_REGION: us-east-1
    AWS_SECRET: &lt;AWS-SECRET&gt;
    AWS_SECURE: &#39;False&#39;
    AWS_USE_SIGV4: &#39;False&#39;
    SETTINGS_FLAVOR: prod
    SEARCH_BACKEND: sqlalchemy
    REGISTRY_AUTH: htpasswd
    REGISTRY_AUTH_HTPASSWD_REALM: &#39;Auth Internal Registry&#39;
    REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
</code></pre></div>
<p>For running cluster you need <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/launch_container_instance.html">setup instances</a> and register these instances into cluster. You can use <a href="http://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-agent-config.html#ecs-config-s3">ecs.config</a> in user data to setup instance.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/bash
yum install -y aws-cli
aws s3 cp s3://&lt;BUCKET-NAME&gt;/ecs.config /etc/ecs/ecs.config
echo ECS_CLUSTER=&lt;CLUSTER-NAME&gt; &gt;&gt; /etc/ecs/ecs.config
</code></pre></div>
<p>You can run task or service in ECS. If you need task as cron you can use lambda for setup <a href="http://stackoverflow.com/questions/27382009/aws-lambda-scheduled-tasks">scheduling task</a>.</p>
<div class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;aws-sdk&#39;</span><span class="p">);</span>
<span class="nx">AWS</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">region</span> <span class="o">=</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ecs</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">ECS</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">MAX_RESULTS</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">runTask</span><span class="p">(</span><span class="nx">taskDefinitionArn</span><span class="p">,</span> <span class="nx">clusterName</span><span class="p">,</span> <span class="nx">numberOfTasks</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">taskDefinition</span><span class="o">:</span> <span class="nx">taskDefinitionArn</span><span class="p">,</span> <span class="cm">/* required */</span>
    <span class="nx">cluster</span><span class="o">:</span> <span class="nx">clusterName</span><span class="p">,</span>
    <span class="nx">count</span><span class="o">:</span> <span class="nx">numberOfTasks</span><span class="p">,</span>
    <span class="nx">overrides</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">startedBy</span><span class="o">:</span> <span class="s1">&#39;nodejs-script&#39;</span>
  <span class="p">};</span>
  <span class="nx">ecs</span><span class="p">.</span><span class="nx">runTask</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span> <span class="c1">// an error occurred</span>
    <span class="k">else</span>     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>           <span class="c1">// successful response</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">succeed</span><span class="p">(</span><span class="nx">runTask</span><span class="p">(</span><span class="s1">&#39;&lt;TASK-NAME&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;CLUSTER-NAME&gt;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div>
<p>If you can run service it&#39;s similar but service is still alive. You can combine ECS with <a href="https://mesosphere.github.io/marathon/">Marathon</a> or <a href="http://mesos.github.io/chronos/">Chronos</a>.</p>

<p>See you tomorrow,<br>
Ladislav</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/12/24/day-twenty-four-docker-advent-summary/">
            Day Twenty Four - Docker Advent Summary 2015
            <small>24 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/23/day-twenty-three-docker-tips-and-tricks/">
            Day Twenty Three - Docker tips and tricks
            <small>23 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/22/day-twenty-two-docker-and-monitoring/">
            Day Twenty Two - Docker and monitoring
            <small>22 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693925-3', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
