<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Docker Advent &middot; Small thoughts about docker in advent
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Docker Advent
        </a>
      </h1>
      <p class="lead">Made by <a href="https://twitter.com/abtris" target="_blank">@abtris</a>.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
      
        
      
        
          
        
      
        
      
        
          
        
      
        
          
        
      

      <a class="sidebar-nav-item" href="https://github.com/abtris/dockeradvent.com">GitHub project</a>
    </nav>

    <p>&copy; 2015. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/17/day-seventeen-docker-and-sphinx-documentation/">
        Day Seventeen - Docker and Sphinx documentation
      </a>
    </h1>

    <span class="post-date">17 Dec 2015</span>

    <p>Hi everyone,<br>
if you write the docs, you can use <a href="http://sphinx-doc.org/">Sphinx</a>. You can share your documentation using <a href="https://readthedocs.org/">Read the Docs</a> portal.</p>

<p>If you look at <a href="https://docs.readthedocs.org/en/latest/getting_started.html#write-your-docs">quickstart</a> how write the docs, you can install python and some tools. This can be complicated if you can use latex for creating PDF version and do you need another version python for your development and some another for write the docs. Some members of your team can&#39;t install anything for update just a few lines.</p>

<h2>Docker solution for Sphinx</h2>

<p>You can use <a href="https://hub.docker.com/r/apiaryio/base-sphinx-doc-dev/">docker image</a>. There is <code>requirements.txt</code> for all python packages:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">Sphinx&gt;=1.3.1
awscli==1.5.2
sphinx_rtd_theme
recommonmark
</code></pre></div>
<p>and Dockerfile based on debian.</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span>        debian:jessie
<span class="k">MAINTAINER</span>  Apiary &lt;sre@apiary.io&gt;

<span class="k">ENV</span> REFRESHED_AT 2015-11-03

COPY requirements.txt /tmp/

<span class="k">RUN</span> apt-get clean <span class="o">&amp;&amp;</span> <span class="err">\</span>
    apt-get update <span class="o">&amp;&amp;</span> <span class="err">\</span>
    apt-get install -y --no-install-recommends python-sphinx <span class="err">\</span>
    graphviz <span class="err">\</span>
    make <span class="err">\</span>
    python-pip <span class="o">&amp;&amp;</span> <span class="err">\</span>
    pip install -r /tmp/requirements.txt <span class="o">&amp;&amp;</span> <span class="err">\</span>
    rm -rf /usr/share/doc/* <span class="o">&amp;&amp;</span> <span class="err">\</span>
    rm -rf /usr/share/locale/* <span class="o">&amp;&amp;</span> <span class="err">\</span>
    rm -rf /var/cache/debconf/*-old <span class="o">&amp;&amp;</span> <span class="err">\</span>
    rm -rf /var/lib/apt/lists/* <span class="o">&amp;&amp;</span> <span class="err">\</span>
    apt-get autoclean -y <span class="o">&amp;&amp;</span> <span class="err">\</span>
    apt-get autoremove -y

<span class="k">RUN</span> mkdir /mnt/docs

<span class="k">WORKDIR</span> /mnt/docs
<span class="k">VOLUME</span> <span class="o">[</span><span class="s1">&#39;/mnt/docs&#39;</span><span class="o">]</span>

<span class="k">CMD</span> make clean html
</code></pre></div>
<p>for running in repository with documentation you can use simple shell script, with support html and latex version. <a href="https://github.com/apiaryio/docker-base-images/blob/master/sphinx-latex-doc-dev/Dockerfile">Latex image size</a> is more than 1GB. Html version have only 100MB.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/bash
if [[ &quot;$@&quot; =~ latex.* ]]; then
    echo &quot;Building with LaTex image&quot;
    docker run -ti --rm -v $(pwd):/mnt/docs:rw -w /mnt/docs apiaryio/base-sphinx-latex-doc-dev $@
else
    echo &quot;Building with html-only image&quot;
    docker run -ti --rm -v $(pwd):/mnt/docs:rw -w /mnt/docs apiaryio/base-sphinx-doc-dev $@
fi
</code></pre></div>
<p>Using is very simple just run <code>./build.sh</code> and <code>open build/html/index.html</code>. You can use your favorite editor to edit sources and after that just run build again and check in browser. This version supports <a href="http://sphinx-doc.org/rest.html">reStructuredText</a> and <a href="https://help.github.com/articles/markdown-basics/">markdown</a>. You can combine both formats into your documentation. I prefer using markdown for simple text as this blog, but for complex documentation with references is better use reStructuredText (rst) format.</p>

<p>If you like write the docs, please check <a href="http://www.writethedocs.org/">Write the Docs</a> conferences and meetups.</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/16/day-sixteen-using-docker-for-cli-tools/">
        Day Sixteen - Using docker for CLI Tools
      </a>
    </h1>

    <span class="post-date">16 Dec 2015</span>

    <p>Hi everyone,<br>
I like one thing at docker and that is isolation. For example we have <a href="https://github.com/apiaryio/polls-api">project Polls API</a> written in Python. For testing API we use tool named <a href="http://dredd.readthedocs.org/en/latest/">Dredd</a> written in NodeJS. I can&#39;t install NodeJS to our system. But you can easy use Docker to solve this problem.</p>

<p>Here is <code>circle.yml</code> file for project:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">machine</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pre</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">echo &#39;DOCKER_OPTS=&quot;-s btrfs -e lxc -D --userland-proxy=false&quot;&#39; | sudo tee -a /etc/default/docker</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo curl -L -o /usr/bin/docker &#39;https://s3-external-1.amazonaws.com/circle-downloads/docker-1.8.3-circleci&#39;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">sudo chmod 0755 /usr/bin/docker</span>
  <span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker</span>
<span class="l-Scalar-Plain">dependencies</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">cache_directories</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="s">&quot;~/bin/docker-compose/&quot;</span>
  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker info</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker version</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">if [[ ! -e ~/bin/docker-compose ]]; then mkdir ~/bin/docker-compose/ &amp;&amp; curl -L https://github.com/docker/compose/releases/download/1.4.2/docker-compose-`uname -s`-`uname -m` &gt; ~/bin/docker-compose/docker-compose &amp;&amp; chmod +x ~/bin/docker-compose/docker-compose; fi</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose --version</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose pull</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker pull apiaryio/dredd</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose build</span>
<span class="l-Scalar-Plain">test</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">pre</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose up -d web</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose run shell python manage.py migrate</span>
  <span class="l-Scalar-Plain">override</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">~/bin/docker-compose/docker-compose run shell python manage.py test</span>
  <span class="l-Scalar-Plain">post</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">./scripts/dredd</span>
</code></pre></div>
<p>and bash script for running dredd is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/bash
# set -x
which docker-compose &gt; /dev/null 1&gt;&amp;1
if [ $? -eq 0 ]; then
  DOCKER_COMPOSE=&#39;docker-compose&#39;
else
  if [ -f ~/bin/docker-compose/docker-compose ]; then
    DOCKER_COMPOSE=&quot;$HOME/bin/docker-compose/docker-compose&quot;
  else
    echo &quot;Cannot find docker-compose!&quot;
    exit 1
  fi
fi
# Sync the database
$DOCKER_COMPOSE run -e DATABASE_URL=sqlite:///dredd.sqlite shell &quot;python manage.py migrate&quot;
# Run the dev server
$DOCKER_COMPOSE up -d web
IPWEB=`docker ps  | grep pollsapi_web | cut -d &#39; &#39; -f1 | xargs docker inspect  | grep IPAddress\&quot;: | cut -d &quot;:&quot; -f2 | tr -d &quot;\&quot;&quot; | tr -d &quot;,&quot; | tr -d &#39;[[:space:]]&#39;`
# Run dredd
docker run -v $(pwd):/root -w /root apiaryio/dredd dredd apiary.apib http://$IPWEB:8080
RESULT=$?
exit $RESULT
</code></pre></div>
<p>You can see setup database using docker-compose. After running web, I get IP address for python server and using this address as parameter for running dredd command.</p>

<p>If you can create image for some tools you can make it as I did for Dredd.</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">from</span> node:0.12

<span class="k">RUN</span> npm install -g dredd

<span class="k">CMD</span> dredd
</code></pre></div>
<p>It&#39;s easy and depends on your tool. Sometimes is better use <code>ENTRYPOINT</code> and <code>CMD</code>. Dredd works out of box without parameters using <code>dredd.yml</code> config. For example API Blueprint parser <a href="https://github.com/apiaryio/drafter">drafter</a> waiting for input from stdin. There is better using <code>ENTRYPOINT</code> and <code>CMD</code> with <code>-h</code> as default parameter.</p>
<div class="highlight"><pre><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span> apiaryio/base-dev-cpp:1.0.0
<span class="k">MAINTAINER</span> Apiary <span class="s2">&quot;sre@apiary.io&quot;</span>


<span class="k">RUN</span> locale-gen en_US.UTF-8
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&quot;LC_ALL=en_US.UTF-8&quot;</span> &gt;&gt; /etc/default/locale
<span class="k">RUN</span> dpkg-reconfigure locales

<span class="k">ADD</span> ./ /drafter

<span class="k">WORKDIR</span> /drafter

<span class="c"># It&#39;s tempting to put ./configure into RUN, but then you have timestamp issues</span>

<span class="k">RUN</span> ./configure <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> make install

<span class="k">ENTRYPOINT</span> /usr/local/bin/drafter
<span class="k">CMD</span> <span class="s2">&quot;-h&quot;</span>
</code></pre></div>
<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/15/day-fifteen-container-lifecycle/">
        Day Fifteen - Container Lifecycle
      </a>
    </h1>

    <span class="post-date">15 Dec 2015</span>

    <p>Hi everyone,<br>
 I can write some details about docker containers lifecycle.</p>

<h2>Container statuses</h2>

<ul>
<li>running</li>
<li>stopped</li>
<li>paused</li>
<li>killed</li>
<li>removed</li>
</ul>

<h2>How change status</h2>

<ul>
<li>image -&gt; <code>docker run</code> -&gt; running</li>
<li>running -&gt; <code>docker pause</code> -&gt; paused -&gt; <code>docker unpause</code> -&gt; running</li>
<li>running -&gt; <code>docker stop</code> -&gt; stopped -&gt; <code>docker start</code> -&gt; running</li>
<li>stopped -&gt; <code>docker rm</code> -&gt; removed</li>
<li>running -&gt; <code>docker kill</code> -&gt; killed -&gt; <code>docker rm</code> -&gt; removed</li>
<li>running -&gt; <code>docker rm --force</code> -&gt; removed</li>
<li>running -&gt; <code>docker restart</code> -&gt; stopped -&gt; running</li>
</ul>

<h2>Docker container lifecycle schema</h2>

<p><img src="/assets/docker-lifecycle-3.png" alt="Docker Container Lifecycle"></p>

<p>You can see you have many containers, sometimes problems with space in VM. Docker consumes big amount of disk space. I use this script <code>docker-cleanup</code> for cleanup my VM. First command remove containers and second remove images.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/bash
# Delete all containers
docker rm $(docker ps -a -q)
# Delete all images
docker rmi $(docker images -q)
</code></pre></div>
<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/14/day-fourteen-docker-lifecycle/">
        Day Fourteen - Docker Lifecycle
      </a>
    </h1>

    <span class="post-date">14 Dec 2015</span>

    <p>Hi everyone,<br>
 I can write some details about docker containers. How images and containers born and die.</p>

<h2>Steps in lifecycle</h2>

<ol>
<li>You have to <code>build</code> <strong>image</strong>. Make <a href="http://localhost:4000/2015/12/07/day-seven-dockerfile/"><code>Dockerfile</code></a> and run <code>docker build</code>.</li>
</ol>

<ul>
<li>you can run <code>docker build .</code></li>
<li>or you add tag name <code>docker build -t username/my-imagename .</code></li>
<li>or you can have <code>Dockerfile</code> somewhere at path <code>docker build -t username/my-imagename -f /path/Dockerfile</code></li>
</ul>

<ol>
<li><p>If you run image by <code>docker run</code> you create <strong>container</strong>. You can check them by <code>docker ps</code>.</p></li>
<li><p>Container can be in different status, you can stop them by <code>docker stop</code>.</p></li>
<li><p>If you make some changes by using terminal <code>docker run -it &lt;image-name&gt; /bin/bash</code> or <code>docker exec -it &lt;container-id&gt; /bin/bash</code>. You can change this <strong>container</strong> into <strong>image</strong>. You have to use <code>docker commit</code> <a href="https://docs.docker.com/engine/reference/commandline/commit/">command</a>.</p></li>
</ol>

<h2>Docker lifecycle schema</h2>

<p><img src="/assets/docker-lifecycle-2.png" alt="Docker Container Lifecycle"></p>

<p>Next, I write post about details and all commands and statuses docker container.</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/13/day-thirteen-docker-and-travisci/">
        Day Thirteen - Docker and TravisCI
      </a>
    </h1>

    <span class="post-date">13 Dec 2015</span>

    <p>Hi everyone,<br>
Docker is great for testing. In last post I write about <a href="http://www.dockeradvent.com/2015/12/12/day-twelve-docker-and-circleci/">CircleCI</a>.</p>

<h2>Travis CI</h2>

<p>TravisCI is most used in Open Source projects at GitHub.</p>

<p>To use Docker add the following settings to your <code>.travis.yml</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">sudo: required

services:
  - docker
</code></pre></div>
<p>You can use <code>docker-compose</code> in similar way as in CircleCI.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">env:
  DOCKER_COMPOSE_VERSION: 1.4.2

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` &gt; docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
</code></pre></div>
<p>I&#39;m not sure about TravisCI and <a href="https://docs.travis-ci.com/user/caching">caching</a> used for docker. TravisCI using docker for normal build too, if you use <code>sudo: false</code> your build using docker at backend.</p>

<h2>Continues Engines</h2>

<p>Many CI systems exists for example <a href="https://drone.io/">drone.io</a> is build at top of docker. It&#39;s have only simple documentation with basics commands showing UI.</p>

<p>We have new generation CI as <a href="http://devcenter.wercker.com/docs/pipelines/per-pipeline-containers.html">Wercker</a> or <a href="https://buildkite.com/docs/guides/docker-containerized-builds">BuildKite</a> with pipelines and better support using docker.</p>

<p>Only future show us who win this battle for best continuous delivery tool.</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/12/day-twelve-docker-and-circleci/">
        Day Twelve - CircleCI and Docker
      </a>
    </h1>

    <span class="post-date">12 Dec 2015</span>

    <p>Hi everyone,<br>
Docker is great for testing. I make a few posts about support in Continues Integration Engines.</p>

<ul>
<li><a href="https://circleci.com/docs/docker">CircleCI</a></li>
<li><a href="https://docs.travis-ci.com/user/docker/">TravisCI</a></li>
<li><a href="https://github.com/jenkinsci/docker">Jenkins</a></li>
<li><a href="http://drone.io/">Drone</a></li>
<li><a href="https://buildkite.com/docs/guides/docker-containerized-builds">BuildKite</a></li>
</ul>

<h2>Circle CI</h2>

<p>To use Docker add required service into <code>circle.yml</code> file:</p>
<div class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="l-Scalar-Plain">machine</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">services</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">docker</span>
</code></pre></div>
<p>you can use this for install different version docker than default (1.8.3):</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">machine:
  pre:
    - echo &#39;DOCKER_OPTS=&quot;-s btrfs -e lxc -D --userland-proxy=false&quot;&#39; | sudo tee -a /etc/default/docker
    - sudo curl -L -o /usr/bin/docker &#39;https://s3-external-1.amazonaws.com/circle-downloads/docker-1.9.0-circleci&#39;
    - sudo chmod 0755 /usr/bin/docker
  services:
    - docker
</code></pre></div>
<p>if you need use own <code>docker-compose</code> version use this in dependencies:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">dependencies:
  cache_directories:
    - &quot;~/bin/docker-compose/&quot;
  override:
    - if [[ ! -e ~/bin/docker-compose ]]; then mkdir ~/bin/docker-compose/; fi
    - if [[ `~/bin/docker-compose/docker-compose -v | cut -d &quot; &quot; -f3` &lt; &quot;1.5.1&quot; ]]; then curl -L https://github.com/docker/compose/releases/download/1.5.1/docker-compose-`uname -s`-`uname -m` &gt; ~/bin/docker-compose/docker-compose &amp;&amp; chmod +x ~/bin/docker-compose/docker-compose; fi
    - ~/bin/docker-compose/docker-compose --version
</code></pre></div>
<p>you can use caching docker layers:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">dependencies:
  cache_directories:
    - &quot;~/docker&quot;

  override:
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -t circleci/elasticsearch .
    - mkdir -p ~/docker; docker save circleci/elasticsearch &gt; ~/docker/image.tar
</code></pre></div>
<p>you have to test if helps performance. For every hosted CI will helps caching docker hub, but I think this isn&#39;t good solution. Look carefully at <a href="https://circleci.com/docs/docker#some-known-caching-issues">caching issues</a>.</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/11/day-eleven-docker-version-manager/">
        Day Eleven - Docker Version Manager
      </a>
    </h1>

    <span class="post-date">11 Dec 2015</span>

    <p>Hi everyone,<br>
Rackspace created <a href="https://getcarina.com/blog/docker-version-manager/">docker version manager</a>, this helps you use more version docker.</p>

<p>I tested on mac and works good. My college try it at linux and have problems combine with package version. But at linux is easy use normal package system to switch native version.</p>

<h2>Install on Mac or Linux</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">curl -sL https://download.getcarina.com/dvm/latest/install.sh | sh
</code></pre></div>
<h2>Usage</h2>

<p>After dvm is installed, list all installed versions of the Docker client:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ dvm ls
  1.8.3
-&gt;  system (1.9.1)
</code></pre></div>
<p>You can install all this versions:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ dvm ls-remote
1.6.0
1.6.1
1.6.2
1.7.0
1.7.1
1.8.0
1.8.1
1.8.2
1.8.3
1.9.0
1.9.1
</code></pre></div>
<p>using <code>dvm install &lt;VERSION&gt;</code>. Switch between version you can use <code>dvm use</code> command. Project you can see at <a href="https://github.com/getcarina/dvm">github</a>.</p>

<p>I love this project. It&#39;s very useful to test new version some as I&#39;m using similar projects for NodeJS (<code>nvm</code>), Ruby (<code>rbenv</code>) or Go (<code>gobrew</code>).</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2015/12/10/day-ten-docker-swarm/">
        Day Ten - Docker Swarm
      </a>
    </h1>

    <span class="post-date">10 Dec 2015</span>

    <p>Hi everyone,<br>
next tool from Docker is <a href="https://docs.docker.com/swarm/">Docker Swarm</a>. It&#39;s native clustering for Docker. You need <a href="https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/">service discovery</a> based on some software as <a href="https://www.consul.io/">consul</a>, <a href="https://coreos.com/etcd/docs/latest/">etcd</a> or <a href="https://zookeeper.apache.org/">zookeeper</a>.</p>

<h2>Setup swarm</h2>

<p>You need docker and first you need generate token.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker run swarm create

Unable to find image &#39;swarm:latest&#39; locally
latest: Pulling from library/swarm

d681c900c6e3: Pull complete
188de6f24f3f: Pull complete
90b2ffb8d338: Pull complete
237af4efea94: Pull complete
3b3fc6f62107: Pull complete
7e6c9135b308: Pull complete
986340ab62f0: Pull complete
a9975e2cc0a3: Pull complete
Digest: sha256:c21fd414b0488637b1f05f13a59b032a3f9da5d818d31da1a4ca98a84c0c781b
Status: Downloaded newer image for swarm:latest
ca5c13a8cb0d2a1da427024b032a138a
</code></pre></div>
<p>Next step is launch swarm manager:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine create \
&gt;         -d virtualbox \
&gt;         --swarm \
&gt;         --swarm-master \
&gt;         --swarm-discovery token://ca5c13a8cb0d2a1da427024b032a138a \
&gt;         swarm-master

Running pre-create checks...
Creating machine...
(swarm-master) OUT | Creating VirtualBox VM...
(swarm-master) OUT | Creating SSH key...
(swarm-master) OUT | Starting VirtualBox VM...
(swarm-master) OUT | Starting VM...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Detecting the provisioner...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Configuring swarm...
To see how to connect Docker to this machine, run: docker-machine env swarm-master
</code></pre></div>
<p>Now you can see two machines:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine ls

NAME           ACTIVE   DRIVER       STATE     URL                         SWARM
dev            *        virtualbox   Running   tcp://192.168.99.100:2376
swarm-master   -        virtualbox   Running   tcp://192.168.99.101:2376   swarm-master (master)
</code></pre></div>
<p>and you need create swarm node:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine create \
&gt;   -d virtualbox \
&gt;   --swarm \
&gt;   --swarm-discovery token://ca5c13a8cb0d2a1da427024b032a138a \
&gt;   swarm-agent-00

Running pre-create checks...
Creating machine...
(swarm-agent-00) OUT | Creating VirtualBox VM...
(swarm-agent-00) OUT | Creating SSH key...
(swarm-agent-00) OUT | Starting VirtualBox VM...
(swarm-agent-00) OUT | Starting VM...
Waiting for machine to be running, this may take a few minutes...
Machine is running, waiting for SSH to be available...
Detecting operating system of created instance...
Detecting the provisioner...
Provisioning created instance...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Configuring swarm...
To see how to connect Docker to this machine, run: docker-machine env swarm-agent-00
</code></pre></div>
<p>and another one:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine create -d virtualbox --swarm --swarm-discovery token://ca5c13a8cb0d2a1da427024b032a138a swarm-agent-01
</code></pre></div>
<p>and now you can see all machines:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine ls

NAME             ACTIVE   DRIVER       STATE     URL                         SWARM
dev              *        virtualbox   Running   tcp://192.168.99.100:2376
swarm-agent-00   -        virtualbox   Running   tcp://192.168.99.102:2376   swarm-master
swarm-agent-01   -        virtualbox   Running   tcp://192.168.99.103:2376   swarm-master
swarm-master     -        virtualbox   Running   tcp://192.168.99.101:2376   swarm-master (master)
</code></pre></div>
<h2>Running swarm</h2>
<div class="highlight"><pre><code class="language-text" data-lang="text">eval $(docker-machine env --swarm swarm-master)
</code></pre></div>
<p>and now you can see:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker-machine ls

NAME             ACTIVE   DRIVER       STATE     URL                         SWARM
dev              -        virtualbox   Running   tcp://192.168.99.100:2376
swarm-agent-00   -        virtualbox   Running   tcp://192.168.99.102:2376   swarm-master
swarm-agent-01   -        virtualbox   Running   tcp://192.168.99.103:2376   swarm-master
swarm-master     *        virtualbox   Running   tcp://192.168.99.101:2376   swarm-master (master)
</code></pre></div>
<p>and you can use docker info about information about your cluster:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker info

Containers: 4
Images: 3
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 3
 swarm-agent-00: 192.168.99.102:2376
  └ Status: Healthy
  └ Containers: 1
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
 swarm-agent-01: 192.168.99.103:2376
  └ Status: Healthy
  └ Containers: 1
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
 swarm-master: 192.168.99.101:2376
  └ Status: Healthy
  └ Containers: 2
  └ Reserved CPUs: 0 / 1
  └ Reserved Memory: 0 B / 1.021 GiB
  └ Labels: executiondriver=native-0.2, kernelversion=4.1.13-boot2docker, operatingsystem=Boot2Docker 1.9.1 (TCL 6.4.1); master : cef800b - Fri Nov 20 19:33:59 UTC 2015, provider=virtualbox, storagedriver=aufs
CPUs: 3
Total Memory: 3.064 GiB
Name: f5395c4e7e6e
</code></pre></div>
<p>you can check <code>docker ps  -a</code> to all containers.</p>

<p>Try run: <code>docker run hello-world</code> and after that <code>docker ps -a</code>:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ docker ps -a

CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS                                     NAMES
35dd40392b49        hello-world         &quot;/hello&quot;                 16 seconds ago      Exited (0) 15 seconds ago                                             swarm-agent-00/sad_hodgkin
0849ac73f36f        swarm:latest        &quot;/swarm join --advert&quot;   3 minutes ago       Up 3 minutes                2375/tcp                                  swarm-agent-01/swarm-agent
008e6e36c7b3        swarm:latest        &quot;/swarm join --advert&quot;   6 minutes ago       Up 6 minutes                2375/tcp                                  swarm-agent-00/swarm-agent
dfef13a18857        swarm:latest        &quot;/swarm join --advert&quot;   9 minutes ago       Up 9 minutes                2375/tcp                                  swarm-master/swarm-agent
f5395c4e7e6e        swarm:latest        &quot;/swarm manage --tlsv&quot;   9 minutes ago       Up 9 minutes                2375/tcp, 192.168.99.101:3376-&gt;3376/tcp   swarm-master/swarm-agent-master
</code></pre></div>
<p>You see our docker container ran on one of our swarm agent.</p>

<p>Swarm support <a href="https://docs.docker.com/swarm/discovery/">multiple discovery backends</a>. You can experiment with others discovery backends.</p>

<p>See you tomorrow,<br>
Ladislav</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>
    </div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37693925-3', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
